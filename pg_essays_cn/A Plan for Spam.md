---
title: "垃圾邮件应对方案"
original_title: "A Plan for Spam"
author: "Paul Graham"
translator: "deepseek-ai/DeepSeek-V3 (SiliconFlow)"
translate_date: "2025-07-14"
source_file: "A Plan for Spam.md"
---

# 垃圾邮件应对方案

| | [](index.html)  
  
|   
  
|  **喜欢构建事物？**试试[Hacker News](http://news.ycombinator.com)。    
  
---  
  
2002年8月  
  
（本文描述了我们在开发基于Arc的防垃圾邮件网页邮件阅读器时使用的垃圾邮件过滤技术。改进后的算法详见[更好的贝叶斯过滤](better.html)。）  
  
我认为阻止垃圾邮件是可能的，而基于内容的过滤器是实现这一目标的方法。垃圾邮件发送者的致命弱点在于他们的信息。他们可以绕过你设置的任何其他障碍。至少到目前为止是这样。但他们必须传递他们的信息，无论它是什么。如果我们能编写出识别他们信息的软件，他们就无法绕过这一点。  
  
_ _ _  
  
对于收件人来说，垃圾邮件很容易识别。如果你雇人阅读你的邮件并丢弃垃圾邮件，他们几乎不会有什么困难。在不涉及人工智能的情况下，我们需要做多少工作才能自动化这一过程？  
  
我认为我们可以用相当简单的算法解决这个问题。事实上，我发现仅使用单个单词的垃圾邮件概率的贝叶斯组合，就可以很好地过滤当前的垃圾邮件。通过稍微调整（如下所述）的贝叶斯过滤器，我们现在每1000封垃圾邮件中漏掉的不到5封，且没有误判。  
  
统计方法通常不是人们编写垃圾邮件过滤器时首先尝试的方法。大多数黑客的第一本能是尝试编写能够识别垃圾邮件个别特征的软件。你看到垃圾邮件时会想，这些家伙居然敢给我发以“亲爱的朋友”开头的邮件，或者主题全是大写并以八个感叹号结尾。我可以用大约一行代码过滤掉这些东西。  
  
于是你这样做，一开始效果不错。几条简单的规则就能大幅减少收到的垃圾邮件。仅查找“点击”这个词就能捕获我垃圾邮件库中79.7%的邮件，误判率仅为1.2%。  
  
在尝试统计方法之前，我花了大约六个月时间编写识别垃圾邮件特征的软件。我发现识别最后几个百分点的垃圾邮件变得非常困难，而且随着过滤器的严格程度提高，误判率也随之增加。  
  
误判是指无辜的邮件被错误地识别为垃圾邮件。对大多数用户来说，错过合法邮件比收到垃圾邮件糟糕得多，因此产生误判的过滤器就像一种可能导致患者死亡的痤疮治疗方法。  
  
用户收到的垃圾邮件越多，他越不可能注意到垃圾邮件文件夹中的一封无辜邮件。奇怪的是，垃圾邮件过滤器越好，误判的危险性就越大，因为当过滤器真的很好时，用户更可能忽略它们捕获的所有内容。  
  
我不知道为什么我这么久才尝试统计方法。我想是因为我沉迷于自己识别垃圾邮件特征，仿佛在与垃圾邮件发送者玩某种竞争游戏。（非黑客通常没有意识到这一点，但大多数黑客非常有竞争意识。）当我尝试统计分析时，立即发现它比我聪明得多。它当然发现了像“virtumundo”和“teens”这样的词是垃圾邮件的良好指标。但它还发现“per”、“FL”和“ff0000”也是垃圾邮件的良好指标。事实上，“ff0000”（表示亮红色的HTML代码）与任何色情词汇一样是垃圾邮件的良好指标。  
  
_ _ _  
  
以下是我如何进行统计过滤的概述。我从一个垃圾邮件库和一个非垃圾邮件库开始。目前每个库中大约有4000封邮件。我扫描每个库中每封邮件的全部文本，包括标题和嵌入的HTML和JavaScript。目前我认为字母数字字符、连字符、撇号和美元符号是标记的一部分，其他所有内容都是标记分隔符。（这里可能还有改进的空间。）我忽略全数字的标记，也忽略HTML注释，甚至不将它们视为标记分隔符。  
  
我计算每个标记（目前忽略大小写）在每个库中出现的次数。在这个阶段，我最终得到两个大型哈希表，每个库一个，将标记映射到出现次数。  
  
接下来我创建第三个哈希表，这次将每个标记映射到包含它的邮件是垃圾邮件的概率，我按以下方式计算[1]：  (let ((g (* 2 (or (gethash word good) 0))) (b (or (gethash word bad) 0))) (unless (< (+ g b) 5) (max .01 (min .99 (float (/ (min 1 (/ b nbad)) (+ (min 1 (/ g ngood)) (min 1 (/ b nbad)))))))))  其中word是我们计算概率的标记，good和bad是我在第一步创建的哈希表，ngood和nbad分别是非垃圾邮件和垃圾邮件的数量。  
  
我用代码解释这一点是为了展示几个重要的细节。我希望稍微偏置概率以避免误判，通过反复试验我发现一个好的方法是将good中的所有数字加倍。这有助于区分偶尔出现在合法邮件中的词和几乎从不出现的词。我只考虑总共出现超过五次的词（实际上，由于加倍，在非垃圾邮件中出现三次就足够了）。然后还有一个问题是如何为在一个库中出现但另一个库中未出现的词分配概率。再次通过反复试验，我选择了0.01和0.99。这里可能有调整的空间，但随着库的增长，这种调整会自动发生。  
  
特别观察的人会注意到，虽然我将每个库视为一个长文本流以计算出现次数，但在计算垃圾邮件概率时，我使用每封邮件的数量而不是它们的总长度作为除数。这增加了另一个轻微的偏置以防止误判。  
  
当新邮件到达时，它被扫描为标记，并使用最有趣的十五个标记（其中“有趣”由它们的垃圾邮件概率与中性0.5的距离衡量）来计算邮件是垃圾邮件的概率。如果probs是十五个单独概率的列表，你可以按以下方式计算[组合](naivebayes.html)概率：  (let ((prod (apply #'* probs))) (/ prod (+ prod (apply #'* (mapcar #'(lambda (x) (- 1 x)) probs)))))  在实践中出现的一个问题是如何为从未见过的词分配概率，即未出现在词概率哈希表中的词。通过反复试验，我发现0.4是一个很好的数字。如果你从未见过一个词，它可能是相当无辜的；垃圾邮件词汇往往过于熟悉。  
  
在末尾的附录中有该算法应用于实际邮件的示例。  
  
如果上述算法给出的邮件是垃圾邮件的概率超过0.9，我就将其视为垃圾邮件。但在实践中，我将这个阈值放在哪里并不重要，因为很少有概率落在中间范围。  
  
_ _ _  
  
统计方法的一个巨大优势是你不需要阅读那么多垃圾邮件。在过去的六个月里，我实际上阅读了数千封垃圾邮件，这真的有点令人沮丧。诺伯特·维纳说，如果你与奴隶竞争，你就会变成奴隶，与垃圾邮件发送者竞争也有类似的降级感。要识别垃圾邮件的个别特征，你必须试图进入垃圾邮件发送者的思维，坦率地说，我尽可能少地花时间在垃圾邮件发送者的思维中。  
  
但贝叶斯方法的真正优势当然是你知道你在测量什么。像SpamAssassin这样的特征识别过滤器为邮件分配垃圾邮件“分数”。贝叶斯方法分配的是实际概率。“分数”的问题在于没有人知道它的含义。用户不知道它的含义，但更糟糕的是，过滤器的开发者也不知道。一封包含“sex”一词的邮件应该得到多少分？概率当然可能是错误的，但它的含义或如何结合证据来计算它几乎没有歧义。根据我的库，“sex”表明包含它的邮件是垃圾邮件的概率为0.97，而“sexy”表明的概率为0.99。贝叶斯规则同样明确，表示一封同时包含这两个词的邮件在（不太可能）没有其他证据的情况下，有99.97%的概率是垃圾邮件。  
  
因为它测量的是概率，贝叶斯方法考虑了邮件中的所有证据，无论是好的还是坏的。在垃圾邮件中不成比例地罕见的词（如“though”、“tonight”或“apparently”）对降低概率的贡献与“unsubscribe”和“opt-in”等坏词对增加概率的贡献一样大。因此，一封恰好包含“sex”一词的无辜邮件不会被标记为垃圾邮件。  
  
当然，理想情况下，应该为每个用户单独计算概率。我收到很多包含“Lisp”一词的邮件，而（到目前为止）没有垃圾邮件包含它。因此，这样的词实际上是向我发送邮件的密码。在我早期的垃圾邮件过滤软件中，用户可以设置这样的词列表，包含这些词的邮件会自动通过过滤器。在我的列表中，我放了“Lisp”和我的邮政编码，以便（听起来相当垃圾邮件的）在线订单收据能够通过。我以为自己很聪明，但我发现贝叶斯过滤器为我做了同样的事情，而且还发现了很多我没想到的词。  
  
我在开头说我们的过滤器每1000封垃圾邮件中漏掉的不到5封，且没有误判，这是基于我的邮件库过滤我的邮件。但这些数字并不误导，因为这是我提倡的方法：根据每个用户收到的垃圾邮件和非垃圾邮件过滤他的邮件。本质上，每个用户应该有两个删除按钮，普通删除和作为垃圾邮件删除。任何作为垃圾邮件删除的内容都会进入垃圾邮件库，其他所有内容进入非垃圾邮件库。  
  
你可以为用户提供一个种子过滤器，但最终每个用户应该根据他实际收到的邮件拥有自己的每词概率。这（a）使过滤器更有效，（b）让每个用户决定自己对垃圾邮件的精确定义，（c）也许最重要的是，使垃圾邮件发送者难以调整邮件以通过过滤器。如果过滤器的大部分智能在于个别数据库中，那么仅仅调整垃圾邮件以通过种子过滤器并不能保证它们能通过个别用户不同且训练有素的过滤器。  
  
基于内容的垃圾邮件过滤通常与白名单结合使用，白名单是无需过滤即可接受的发件人列表。构建这样一个白名单的一个简单方法是保留用户曾经发送过邮件的每个地址的列表。如果邮件阅读器有一个“作为垃圾邮件删除”按钮，你也可以将用户作为普通垃圾删除的每封邮件的发件人地址添加到白名单中。  
  
我是白名单的支持者，但更多是为了节省计算而不是改善过滤。我曾经认为白名单会使过滤更容易，因为你只需要过滤从未听说过的人发来的邮件，而第一次给你发邮件的人在可以对你说的话上受到惯例的限制。你已经认识的人可能会给你发一封谈论性的邮件，但第一次给你发邮件的人不太可能这样做。问题是，人们可以有多个电子邮件地址，因此一个新的发件人地址并不能保证发件人是第一次给你写信。一个老朋友（尤其是如果他是一个黑客）突然用一个新发件人地址给你发邮件并不罕见，因此你不能冒险通过特别严格地过滤来自未知地址的邮件而产生误判。  
  
在某种意义上，我的过滤器本身体现了一种白名单（和黑名单），因为它们基于包括标题在内的整个邮件。因此，它们在某种程度上“知道”可信发件人的电子邮件地址，甚至邮件从他们到我这里的路径。它们也知道垃圾邮件的相同信息，包括服务器名称、邮件程序版本和协议。  
  
_ _ _  
  
如果我认为可以保持当前的垃圾邮件过滤率，我会认为这个问题已经解决。但能够过滤掉当前大多数垃圾邮件并不意味着什么，因为垃圾邮件在演变。事实上，大多数[反垃圾邮件技术](falsepositives.html)到目前为止就像杀虫剂，除了产生新的抗药性虫害外什么也没做。  
  
我对贝叶斯过滤器更有希望，因为它们与垃圾邮件一起演变。因此，当垃圾邮件发送者开始使用“c0ck”而不是“cock”来逃避基于单个单词的简单垃圾邮件过滤器时，贝叶斯过滤器会自动注意到。事实上，“c0ck”比“cock”更有力的证据，贝叶斯过滤器准确地知道有多少。  
  
尽管如此，任何提出垃圾邮件过滤计划的人都必须能够回答这个问题：如果垃圾邮件发送者确切知道你在做什么，他们能多大程度上绕过你？例如，我认为如果基于校验和的垃圾邮件过滤成为一个严重的障碍，垃圾邮件发送者会转而使用填空技术生成邮件正文。  
  
要击败贝叶斯过滤器，垃圾邮件发送者仅仅使他们的邮件唯一或停止使用个别不良词汇是不够的。他们必须使他们的邮件与你的普通邮件无法区分。我认为这将严重限制他们。垃圾邮件大多是销售宣传，因此除非你的普通邮件全是销售宣传，否则垃圾邮件不可避免地会有不同的特点。当然，垃圾邮件发送者还必须改变（并不断改变）他们的整个基础设施，否则无论他们对邮件正文做了什么，标题对贝叶斯过滤器来说仍然看起来很糟糕。我对垃圾邮件发送者使用的基础设施了解不够，不知道使标题看起来无辜有多难，但我的猜测是这比使邮件看起来无辜更难。  
  
假设他们能解决标题问题，未来的垃圾邮件可能会是这样的：  嘿，你应该看看这个：http://www.27meg.com/foo  因为基于内容的过滤给垃圾邮件发送者留下的空间大约就是这么多销售宣传。（事实上，即使这样也很难通过过滤器，因为如果邮件中的其他所有内容都是中性的，垃圾邮件的概率将取决于URL，而要使URL看起来中性需要一些努力。）  
  
垃圾邮件发送者的范围从运行所谓的“选择加入”列表甚至不试图隐藏身份的企业，到劫持邮件服务器发送宣传色情网站的垃圾邮件的家伙。如果我们使用过滤将他们的选择范围缩小到像上面这样的邮件，那应该会让垃圾邮件发送者中“合法”的一端破产；他们感到有义务根据各种州法律包括关于为什么他们的垃圾邮件不是垃圾邮件的样板文件，以及如何取消“订阅”，而这种文本很容易识别。  
  
（我曾经认为相信更严格的法律会减少垃圾邮件是天真的。现在我认为，虽然更严格的法律可能不会减少垃圾邮件发送者发送的垃圾邮件数量，但它们肯定可以帮助过滤器减少收件人实际看到的垃圾邮件数量。）  
  
在整个范围内，如果你限制垃圾邮件发送者可以做的销售宣传，你不可避免地会让他们破产。记住“business”这个词很重要。垃圾邮件发送者是商人。他们发送垃圾邮件是因为它有效。它有效是因为尽管响应率低得可怕（最多每百万15次，而目录邮寄为每百万3000次），但对他们来说成本几乎为零。对收件人来说成本是巨大的，每百万收件人花一秒删除垃圾邮件大约需要5人周，但垃圾邮件发送者不必支付这笔费用。  
  
发送垃圾邮件确实会给垃圾邮件发送者带来一些成本。[2]因此，我们能够将响应率降低得越多——无论是通过过滤，还是通过使用过滤器迫使垃圾邮件发送者稀释他们的宣传——越少的企业会发现发送垃圾邮件值得。  
  
垃圾邮件发送者使用他们所做的[销售宣传](http://www.milliondollaremails.com)类型的原因是提高响应率。这可能比进入垃圾邮件发送者的思维更令人厌恶，但让我们快速看一下回应垃圾邮件的人的思维。这个人要么令人难以置信地轻信，要么深深地否认他们的性兴趣。无论是哪种情况，垃圾邮件对我们来说看起来多么令人反感或愚蠢，对他们来说是令人兴奋的。垃圾邮件发送者如果不说这些听起来令人兴奋的话就不会说这些话。而“你应该看看这个”对垃圾邮件接收者的吸引力远不如垃圾邮件发送者现在说的那些话。结果：如果它不能包含令人兴奋的销售宣传，垃圾邮件作为营销工具的效果就会降低，更少的企业会想使用它。  
  
这是最终的巨大胜利。我开始编写垃圾邮件过滤软件是因为我不想再看这些东西了。但如果我们过滤垃圾邮件的能力足够好，它将停止工作，垃圾邮件发送者实际上会停止发送它。  
  
_ _ _  
  
在所有对抗垃圾邮件的方法中，从软件到法律，我相信贝叶斯过滤将是最有效的单一方法。但我也认为，我们采取的不同类型的反垃圾邮件努力越多越好，因为任何限制垃圾邮件发送者的措施都会使过滤更容易。即使在基于内容的过滤领域内，我认为同时使用许多不同类型的软件也是一件好事。过滤器越多，垃圾邮件发送者调整邮件以通过它们的难度就越大。  
  
  
  
**附录：过滤示例**  
  
[这里](https://sep.turbifycdn.com/ty/cdn/paulgraham/spam1.txt?t=1688221954&)是我在写这篇文章时收到的一封垃圾邮件的示例。这封垃圾邮件中最有趣的十五个词是：  qvp0045 indira mx-05 intimail $7500 freeyankeedom cdo bluefoxmedia jpg unsecured platinum 3d0 qves 7c5 7c266675  这些词是标题和邮件正文的混合，这是垃圾邮件的典型特征。同样典型的是，在我的数据库中，这些词中的每一个的垃圾邮件概率都是0.99。实际上，有超过十五个词的垃圾邮件概率为0.99，这些只是前十五个。  
  
不幸的是，这使得这封邮件成为贝叶斯规则应用的一个无聊例子。要看到各种有趣的概率，我们必须看看[这封](https://sep.turbifycdn.com/ty/cdn/paulgraham/spam2.txt?t=1688221954&)实际上相当不典型的垃圾邮件。  
  
这封垃圾邮件中最有趣的十五个词及其概率是：  madam 0.99 promotion 0.99 republic 0.99 shortest 0.047225013 mandatory 0.047225013 standardization 0.07347802 sorry 0.08221981 supported 0.09019077 people's 0.09019077 enter 0.9075001 quality 0.8921298 organization 0.12454646 investment 0.8568143 very 0.14758544 valuable 0.82347786  这次的证据是好坏参半。像“shortest”这样的词几乎和“madam”或“promotion”这样的词对罪证的贡献一样大。但罪证仍然更强。如果你根据贝叶斯规则结合这些数字，得到的概率是0.9027。  
  
“Madam”显然来自以“亲爱的先生或女士”开头的垃圾邮件。它们不是很常见，但“madam”这个词在我的合法邮件中从未出现过，这完全是比例的问题。  
  
“Republic”得分高是因为它经常出现在尼日利亚诈骗邮件中，也在一两封提到韩国和南非的垃圾邮件中出现过。你可能会说它帮助识别这封垃圾邮件是偶然的。但我在检查垃圾邮件概率时发现，有很多这样的偶然，它们有一种不可思议的趋势，会推动事情向正确的方向发展而不是错误的方向。在这种情况下，“Republic”出现在尼日利亚诈骗邮件和这封垃圾邮件中并不完全是巧合。有一整类涉及欠发达国家的可疑商业提案，而这些国家更有可能明确指定（因为它们不是）它们是共和国的名称。[3]  
  
另一方面，“enter”是一个真正的失误。它主要出现在退订说明中，但在这里以一种完全无辜的方式使用。幸运的是，统计方法相当稳健，可以在结果开始偏离之前容忍相当多的失误。  
  
作为对比，[这里](https://sep.turbifycdn.com/ty/cdn/paulgraham/hostexspam.txt?t=1688221954&)是一个罕见的例子，一封通过过滤器的垃圾邮件。为什么？因为纯粹偶然，它恰好充满了出现在我实际邮件中的词：  perl 0.01 python 0.01 tcl 0.01 scripting 0.01 morris 0.01 graham 0.01491078 guarantee 0.9762507 cgi 0.973

***  
  
---